# Development Dockerfile with all build tools

FROM python:3.11-slim

# Install all build dependencies
RUN apt-get update && apt-get install -y \
    curl \
    gcc \
    g++ \
    make \
    cmake \
    git \
    ca-certificates \
    && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y \
    && rm -rf /var/lib/apt/lists/*

# Add Rust to PATH
ENV PATH="/root/.cargo/bin:${PATH}"

WORKDIR /app

# Install Python dependencies
COPY requirements.txt pyproject.toml setup.py ./
RUN pip install --no-cache-dir -e ".[dev,websocket]" && \
    pip install --no-cache-dir debugpy watchdog

# Install Node.js dependencies
COPY package.json ./
RUN npm install

# Copy source code
COPY . .

# Create data and logs directories
RUN mkdir -p /app/data /app/logs

EXPOSE 8765 5678

CMD ["python", "production_websocket_server.py"]
